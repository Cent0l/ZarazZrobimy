<div class="container my-4">
  <div class="container text-center">
    <h2 class="mb-4">üìä Historia sprzeda≈ºy w lombardzie üìä</h2>
  </div>

  <div *ngIf="isLoading" class="d-flex justify-content-center">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">≈Åadowanie...</span>
    </div>
  </div>

  <div *ngIf="error" class="alert alert-danger">
    {{ error }}
  </div>

  <div *ngIf="!isLoading && !error && transactions.length === 0" class="alert alert-info">
    Brak historii transakcji sprzeda≈ºy
  </div>

  <div *ngIf="!isLoading && !error && transactions.length > 0">
    <!-- Summary card -->
    <div class="card mb-4">
      <div class="card-header">
        <h5>Podsumowanie sprzeda≈ºy</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-3">
            <h6>Ca≈Çkowity koszt zakupu</h6>
            <p>{{ totalBought | number:'1.2-2' }} PLN</p>
          </div>
          <div class="col-md-3">
            <h6>Ca≈Çkowita warto≈õƒá sprzeda≈ºy</h6>
            <p>{{ totalSold | number:'1.2-2' }} PLN</p>
          </div>
          <div class="col-md-3">
            <h6>Ca≈Çkowity zysk</h6>
            <p [ngClass]="getMarginClass(totalProfit)">
              {{ totalProfit | number:'1.2-2' }} PLN
            </p>
          </div>
          <div class="col-md-3">
            <h6>Zysk procentowy</h6>
            <p [ngClass]="getMarginClass(totalProfitPercentage)">
              {{ totalProfitPercentage | number:'1.2-2' }}%
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Transactions table -->
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead class="table-dark">
        <tr>
          <th (click)="sort('transactionDate')" class="sortable-header">
            Data sprzeda≈ºy
            <span *ngIf="sortColumn === 'transactionDate'" class="ms-1">
                {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
              </span>
          </th>
          <th (click)="sort('customerName')" class="sortable-header">
            KupujƒÖcy
            <span *ngIf="sortColumn === 'customerName'" class="ms-1">
                {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
              </span>
          </th>
          <th (click)="sort('employeeName')" class="sortable-header">
            SprzedajƒÖcy pracownik
            <span *ngIf="sortColumn === 'employeeName'" class="ms-1">
                {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
              </span>
          </th>
          <th (click)="sort('itemName')" class="sortable-header">
            Przedmiot
            <span *ngIf="sortColumn === 'itemName'" class="ms-1">
                {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
              </span>
          </th>
          <th (click)="sort('brand')" class="sortable-header">
            Marka
            <span *ngIf="sortColumn === 'brand'" class="ms-1">
                {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
              </span>
          </th>
          <th (click)="sort('model')" class="sortable-header">
            Model
            <span *ngIf="sortColumn === 'model'" class="ms-1">
                {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
              </span>
          </th>
          <th (click)="sort('serialNumber')" class="sortable-header">
            Nr seryjny
            <span *ngIf="sortColumn === 'serialNumber'" class="ms-1">
                {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
              </span>
          </th>
          <th (click)="sort('condition')" class="sortable-header">
            Stan
            <span *ngIf="sortColumn === 'condition'" class="ms-1">
                {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
              </span>
          </th>
          <th (click)="sort('price')" class="sortable-header">
            Cena zakupu
            <span *ngIf="sortColumn === 'price'" class="ms-1">
                {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
              </span>
          </th>
          <th (click)="sort('totalAmount')" class="sortable-header">
            Cena sprzeda≈ºy
            <span *ngIf="sortColumn === 'totalAmount'" class="ms-1">
                {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
              </span>
          </th>
          <th>Zysk</th>
          <th>Zysk %</th>
          <th>Notatki</th>
        </tr>
        </thead>
        <tbody>
        <ng-container *ngFor="let transaction of transactions">
          <ng-container *ngFor="let item of transaction.items">
            <tr>
              <td>{{ transaction.transactionDate }}</td>
              <td>{{ transaction.customerName }}</td>
              <td>{{ transaction.employeeName }}</td>
              <td>{{ item.itemName }}</td>
              <td>{{ item.brand }}</td>
              <td>{{ item.model }}</td>
              <td>{{ item.serialNumber || '-' }}</td>
              <td>
                  <span data-bs-toggle="tooltip" [attr.data-bs-title]="item.condition" class="cursor-help">
                    <ng-container [ngSwitch]="getConditionRating(item.condition)">
                      <span *ngSwitchCase="5" class="text-warning">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</span>
                      <span *ngSwitchCase="4" class="text-warning">‚≠ê‚≠ê‚≠ê‚≠ê</span>
                      <span *ngSwitchCase="3" class="text-warning">‚≠ê‚≠ê‚≠ê</span>
                      <span *ngSwitchCase="2" class="text-warning">‚≠ê‚≠ê</span>
                      <span *ngSwitchCase="1" class="text-warning">‚≠ê</span>
                      <span *ngSwitchDefault>{{ item.condition || '-' }}</span>
                    </ng-container>
                  </span>
              </td>
              <td class="text-nowrap">{{ item.price | number:'1.2-2' }} PLN</td>
              <td class="text-nowrap">{{ transaction.totalAmount | number:'1.2-2' }} PLN</td>
              <td class="text-nowrap" [ngClass]="getMarginClass(calculateMargin(item, transaction))">
                {{ calculateMargin(item, transaction) | number:'1.2-2' }} PLN
              </td>
              <td class="text-nowrap" [ngClass]="getMarginClass(calculateMarginPercentage(item, transaction))">
                {{ calculateMarginPercentage(item, transaction) | number:'1.2-2' }}%
              </td>
              <td>{{ transaction.notes }}</td>
            </tr>
          </ng-container>
        </ng-container>
        </tbody>
      </table>
      <button (click)="resetSort()" class="btn btn-outline-secondary btn-sm mb-3">
        <i class="bi bi-arrow-counterclockwise"></i> Resetuj sortowanie
      </button>
    </div>
  </div>
</div>
