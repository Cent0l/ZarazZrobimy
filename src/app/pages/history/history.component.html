<div class="container my-4">
  <div class="container text-center">
    <h2 class="mb-4">üìú Historia sprzeda≈ºy w lombardzie üìú</h2>
  </div>

  <div *ngIf="isLoading" class="d-flex justify-content-center">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">≈Åadowanie...</span>
    </div>
  </div>

  <div *ngIf="error" class="alert alert-danger">
    {{ error }}
  </div>

  <div *ngIf="!isLoading && !error && transactions.length === 0" class="alert alert-info">
    Brak historii transakcji sprzeda≈ºy
  </div>

  <div *ngIf="!isLoading && !error && transactions.length > 0">
    <!-- Summary card -->
    <div class="card mb-4">
      <div class="card-header">
        <h5>Podsumowanie sprzeda≈ºy</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-3">
            <h6>Ca≈Çkowity koszt zakupu</h6>
            <p>{{ totalBought | number:'1.2-2' }} PLN</p>
          </div>
          <div class="col-md-3">
            <h6>Ca≈Çkowita warto≈õƒá sprzeda≈ºy</h6>
            <p>{{ totalSold | number:'1.2-2' }} PLN</p>
          </div>
          <div class="col-md-3">
            <h6>Ca≈Çkowity zysk</h6>
            <p [ngClass]="getMarginClass(totalProfit)">
              {{ totalProfit | number:'1.2-2' }} PLN
            </p>
          </div>
          <div class="col-md-3">
            <h6>Zysk procentowy</h6>
            <p [ngClass]="getMarginClass(totalProfitPercentage)">
              {{ totalProfitPercentage | number:'1.2-2' }}%
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Transactions table -->
    <div class="table-responsive-wrapper">
      <div class="mb-2 d-block d-lg-none small text-muted text-center">
        <em>Przesu≈Ñ tabelƒô w lewo/prawo, aby zobaczyƒá wiƒôcej danych</em>
      </div>

      <table class="table table-striped table-hover table-responsive-xl smart-table">
        <thead class="table-dark">
        <tr>
          <th (click)="sort('transactionDate')" class="sortable-header">
            Data
            <span *ngIf="sortColumn === 'transactionDate'" class="ms-1">
                {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
              </span>
          </th>
          <th (click)="sort('customerName')" class="sortable-header">
            KupujƒÖcy
            <span *ngIf="sortColumn === 'customerName'" class="ms-1">
                {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
              </span>
          </th>
          <th (click)="sort('itemName')" class="sortable-header">
            Przedmiot
            <span *ngIf="sortColumn === 'itemName'" class="ms-1">
                {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
              </span>
          </th>
          <th (click)="sort('brand')" class="sortable-header">
            Marka
            <span *ngIf="sortColumn === 'brand'" class="ms-1">
                {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
              </span>
          </th>
          <th (click)="sort('model')" class="sortable-header">
            Model
            <span *ngIf="sortColumn === 'model'" class="ms-1">
                {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
              </span>
          </th>
          <th (click)="sort('condition')" class="sortable-header">
            Stan
            <span *ngIf="sortColumn === 'condition'" class="ms-1">
                {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
              </span>
          </th>
          <th (click)="sort('price')" class="sortable-header">
            Zakup
            <span *ngIf="sortColumn === 'price'" class="ms-1">
                {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
              </span>
          </th>
          <th (click)="sort('totalAmount')" class="sortable-header">
            Sprzeda≈º
            <span *ngIf="sortColumn === 'totalAmount'" class="ms-1">
                {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
              </span>
          </th>
          <th (click)="sort('profit')" class="sortable-header">
            Zysk
            <span *ngIf="sortColumn === 'profit'" class="ms-1">
                {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
              </span>
          </th>
          <th (click)="sort('profitPercentage')" class="sortable-header">
            %
            <span *ngIf="sortColumn === 'profitPercentage'" class="ms-1">
                {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
              </span>
          </th>
        </tr>
        </thead>
        <tbody>
        <ng-container *ngFor="let transaction of transactions">
          <ng-container *ngFor="let item of transaction.items">
            <tr>
              <td data-label="Data">{{ transaction.transactionDate }}</td>
              <td data-label="KupujƒÖcy">{{ transaction.customerName }}</td>
              <td data-label="Przedmiot">{{ item.itemName }}</td>
              <td data-label="Marka">{{ item.brand }}</td>
              <td data-label="Model">{{ item.model }}</td>
              <td data-label="Stan">
                  <span data-bs-toggle="tooltip" [attr.data-bs-title]="item.condition" class="cursor-help">
                    <ng-container [ngSwitch]="getConditionRating(item.condition)">
                      <span *ngSwitchCase="5" class="text-warning">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</span>
                      <span *ngSwitchCase="4" class="text-warning">‚≠ê‚≠ê‚≠ê‚≠ê</span>
                      <span *ngSwitchCase="3" class="text-warning">‚≠ê‚≠ê‚≠ê</span>
                      <span *ngSwitchCase="2" class="text-warning">‚≠ê‚≠ê</span>
                      <span *ngSwitchCase="1" class="text-warning">‚≠ê</span>
                      <span *ngSwitchDefault>{{ item.condition || '-' }}</span>
                    </ng-container>
                  </span>
              </td>
              <td data-label="Zakup" class="text-nowrap">{{ item.price | number:'1.2-2' }} PLN</td>
              <td data-label="Sprzeda≈º" class="text-nowrap">{{ transaction.totalAmount | number:'1.2-2' }} PLN</td>
              <td data-label="Zysk" class="text-nowrap" [ngClass]="getMarginClass(calculateMargin(item, transaction))">
                {{ calculateMargin(item, transaction) | number:'1.2-2' }} PLN
              </td>
              <td data-label="%" class="text-nowrap" [ngClass]="getMarginClass(calculateMarginPercentage(item, transaction))">
                {{ calculateMarginPercentage(item, transaction) | number:'1.2-2' }}%
              </td>
            </tr>
          </ng-container>
        </ng-container>
        </tbody>
      </table>
      <button (click)="resetSort()" class="btn btn-outline-secondary btn-sm mb-3">
        <i class="bi bi-arrow-counterclockwise"></i> Resetuj sortowanie
      </button>
    </div>

    <!-- Mobile info modal for detailed view -->
    <div class="modal fade" id="itemDetailsModal" tabindex="-1" aria-labelledby="itemDetailsModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="itemDetailsModalLabel">Szczeg√≥≈Çy przedmiotu</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" *ngIf="selectedItem">
            <p><strong>Pracownik:</strong> {{ selectedTransaction?.employeeName }}</p>
            <p><strong>Nr seryjny:</strong> {{ selectedItem.serialNumber || '-' }}</p>
            <p><strong>Notatki:</strong> {{ selectedTransaction?.notes || 'Brak notatek' }}</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zamknij</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
